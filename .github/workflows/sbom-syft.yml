name: SBOM (Syft 1.37.0)

on:
  workflow_dispatch:
    inputs:
      source_repo:
        description: "Repository to scan (owner/repo)"
        required: true
        default: "vercel/serve-handler"
      release_tag:
        description: "Git ref to scan (tag or branch)"
        required: true
        default: "6.1.6"

jobs:
  generate-sbom:
    name: Generate SPDX SBOM with syft 1.37.0
    runs-on: ubuntu-latest
    steps:
      - name: Checkout source to scan
        uses: actions/checkout@v4
        with:
          repository: ${{ inputs.source_repo }}
          ref: ${{ inputs.release_tag }}
          path: source

      - name: Checkout this repo for workflow scripts
        uses: actions/checkout@v4
        with:
          path: automation

      - name: Setup Node.js 18.x
        uses: actions/setup-node@v4
        with:
          node-version: "18"

      - name: Install production+dev dependencies (prefer npm ci)
        working-directory: source
        shell: bash
        run: |
          set -euxo pipefail
          if [ -f package-lock.json ]; then
            npm ci
          else
            npm install
          fi

      - name: Install jq
        run: sudo apt-get update && sudo apt-get install -y jq

      - name: Install syft 1.37.0
        shell: bash
        run: |
          set -euxo pipefail
          curl -sSfL https://raw.githubusercontent.com/anchore/syft/main/install.sh | sudo sh -s -- -b /usr/local/bin v1.37.0
          syft version

      - name: Generate SPDX 2.3 JSON SBOM with syft 1.37.0
        shell: bash
        run: |
          set -euxo pipefail
          syft -vv dir:source -o spdx-json > sbom.spdx.json
          test "$(jq -r '.spdxVersion' sbom.spdx.json)" = "SPDX-2.3"

      - name: Export full npm dependency tree (prod+dev)
        working-directory: source
        shell: bash
        run: |
          set -euxo pipefail
          npm ls --all --json > ../deps.npm.json || true

      - name: Export license info via license-checker (prod+dev)
        working-directory: source
        shell: bash
        run: |
          set -euxo pipefail
          npx --yes license-checker --json --production --development > ../license-checker.json

      - name: Compute binary hashes (dist/, bin/ if any)
        shell: bash
        run: |
          set -euxo pipefail
          bash automation/scripts/list-binaries.sh source > binary-hashes.txt

      - name: Extract SBOM metrics & CSV
        shell: bash
        run: |
          set -euxo pipefail
          bash automation/scripts/extract-spdx-metrics.sh sbom.spdx.json

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: sbom-artifacts
          path: |
            sbom.spdx.json
            deps.npm.json
            license-checker.json
            spdx-dependencies.csv
            metrics.txt
            binary-hashes.txt

  license-scan-files:
    name: Optional - ScanCode file-level license & copyright (no node_modules)
    runs-on: ubuntu-latest
    needs: generate-sbom
    steps:
      - name: Checkout source to scan
        uses: actions/checkout@v4
        with:
          repository: ${{ inputs.source_repo }}
          ref: ${{ inputs.release_tag }}
          path: source

      - name: Run ScanCode Toolkit in Docker (exclude node_modules, dist)
        shell: bash
        run: |
          set -euxo pipefail
          docker run --rm -v "$PWD/source:/work" aboutcode/scancode-toolkit:v32.4.1 \
            --format json-pp \
            --license --copyright \
            --info \
            --processes 2 \
            --timeout 600 \
            --strip-root \
            --exclude "**/node_modules/**" \
            --exclude "**/dist/**" \
            /work > scancode-report.json
          jq '{
            files: (.files | length),
            detected_licenses: ( [ .files[]?.licenses[]?.spdx_license_key ] | map(select(.!=null)) | unique | sort ),
            copyrights: ( [ .files[]?.copyrights[]?.value ] | map(select(.!=null)) | length )
          }' scancode-report.json > scancode-summary.txt || true

      - name: Upload ScanCode artifacts
        uses: actions/upload-artifact@v4
        with:
          name: scancode-artifacts
          path: |
            scancode-report.json
            scancode-summary.txt
